{% extends "base.html" %}

{% block title %}Smart Waste Collection Dashboard{% endblock %}

{% block content %}

<!-- =================== HEADER =================== -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Smart Waste Collection Dashboard</h1>

    <div>
        <a href="/dev/upload_test_predictions" 
           class="btn btn-outline-info me-2"
           id="btn-upload-predictions">
            Upload Predictions
        </a>
        <a href="/dev/upload_route_test"
           class="btn btn-outline-warning"
           id="btn-upload-route"
           style="display:none;">
            Optimize Route
        </a>
    </div>
</div>

<p class="text-secondary mb-4">
    ML-powered waste collection optimization with KNN route planning
</p>

<!-- =================== TABS =================== -->
<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-test-pred" data-bs-toggle="tab"
            data-bs-target="#panel-test-pred" type="button" role="tab">
      1. Predictions (Test)
    </button>
  </li>

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-route" data-bs-toggle="tab"
            data-bs-target="#panel-route" type="button" role="tab">
      2. Optimal Route (Test)
    </button>
  </li>

  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-proto-pred" data-bs-toggle="tab"
            data-bs-target="#panel-proto-pred" type="button" role="tab">
      3. Prototype Predictions
    </button>
  </li>
</ul>

<!-- =================== TAB CONTENT =================== -->
<div class="tab-content mt-3">

  <!-- ------------ TAB 1: PREDICTIONS ------------ -->
  <div class="tab-pane fade show active" id="panel-test-pred" role="tabpanel">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Bins Predicted Full Soon</h4>
        <p class="text-secondary">ML predictions sorted by urgency</p>

        <div class="table-responsive">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Bin ID</th>
                <th>Location</th>
                <th>Fill %</th>
                <th>Predicted Full At</th>
              </tr>
            </thead>
            <tbody id="test-predictions-body">
              <tr><td colspan="5" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ------------ TAB 2: ROUTE ------------ -->
  <div class="tab-pane fade" id="panel-route" role="tabpanel">
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="card-title mb-0">Optimal Collection Route (KNN)</h4>
          <button class="btn btn-sm btn-outline-info" onclick="refreshRoute()">
            Refresh Route
          </button>
        </div>
        <p class="text-secondary">Nearest neighbor algorithm for efficient collection</p>

        <!-- Route Statistics -->
        <div class="row mb-3" id="route-stats">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Total Stops</div>
              <div class="stat-value" id="stat-stops">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Total Distance</div>
              <div class="stat-value" id="stat-distance">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Est. Time</div>
              <div class="stat-value" id="stat-time">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Avg Speed</div>
              <div class="stat-value">30 km/h</div>
            </div>
          </div>
        </div>

        <!-- Map -->
        <div id="route-map" style="height: 500px; border-radius: 8px; overflow: hidden;"></div>

        <!-- Route Table -->
        <div class="mt-4 table-responsive">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>Stop #</th>
                <th>Label</th>
                <th>Bin ID</th>
                <th>Coordinates</th>
                <th>Distance (km)</th>
                <th>Travel Time (min)</th>
              </tr>
            </thead>
            <tbody id="route-stops-body">
              <tr><td colspan="6" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ------------ TAB 3: PROTOTYPE ------------ -->
  <div class="tab-pane fade" id="panel-proto-pred" role="tabpanel">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Prototype Predictions</h4>
        <p class="text-secondary">Live sensor data predictions</p>

        <div class="table-responsive">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Bin ID</th>
                <th>Location</th>
                <th>Fill %</th>
                <th>Predicted Full At</th>
              </tr>
            </thead>
            <tbody id="proto-predictions-body">
              <tr><td colspan="5" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>

<style>
  .stat-card {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #444;
  }
  .stat-label {
    font-size: 0.85rem;
    color: #aaa;
    margin-bottom: 5px;
  }
  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #0d6efd;
  }
  .leaflet-popup-content {
    color: #000;
  }
</style>

{% endblock %}

{% block extra_scripts %}
<script>

  /* ======================================================
     SHOW CORRECT UPLOAD BUTTON FOR SELECTED TAB
  ====================================================== */
  function updateUploadButtons(activeTab) {
    const btnPred = document.getElementById("btn-upload-predictions");
    const btnRoute = document.getElementById("btn-upload-route");

    if (activeTab === "panel-test-pred") {
        btnPred.style.display = "inline-block";
        btnRoute.style.display = "none";
    }
    else if (activeTab === "panel-route") {
        btnPred.style.display = "none";
        btnRoute.style.display = "inline-block";
    }
    else {
        btnPred.style.display = "none";
        btnRoute.style.display = "none";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const tabs = document.querySelectorAll('button[data-bs-toggle="tab"]');

    tabs.forEach(btn => {
        btn.addEventListener("shown.bs.tab", (event) => {
            const target = event.target.getAttribute("data-bs-target").substring(1);
            updateUploadButtons(target);
        });
    });

    updateUploadButtons("panel-test-pred");
  });

  /* ======================================================
     LOAD PREDICTIONS
  ====================================================== */
  async function loadPredictions(source, tbodyId) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = '<tr><td colspan="5" class="text-center">Loading...</td></tr>';

    try {
      const res = await fetch('/api/predictions?source=' + source);
      const data = await res.json();

      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-secondary">No predictions found</td></tr>';
        return;
      }

      tbody.innerHTML = '';
      data.forEach((row, idx) => {
        const tr = document.createElement('tr');

        const location = (row.lat && row.lon)
            ? `${row.lat.toFixed(4)}, ${row.lon.toFixed(4)}`
            : (row.location_name || '-');

        const fillClass = row.predicted_fill_percent >= 80 ? 'text-danger' : 
                         row.predicted_fill_percent >= 60 ? 'text-warning' : '';

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td><code>${row.bin_id || '-'}</code></td>
          <td><small>${location}</small></td>
          <td class="${fillClass}"><strong>${row.predicted_fill_percent != null ? row.predicted_fill_percent.toFixed(1) + '%' : '-'}</strong></td>
          <td><small>${row.predicted_full_at || '-'}</small></td>
        `;
        tbody.appendChild(tr);
      });

    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading data</td></tr>';
    }
  }

  /* ======================================================
     ROUTE MAP + TABLE
  ====================================================== */
  let map;
  let routeLayer;
  let markers = [];

  function initMap() {
    map = L.map('route-map').setView([55.6761, 12.5683], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);
  }

  async function loadRoute(source) {
    const tbody = document.getElementById('route-stops-body');
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

    try {
      const res = await fetch('/api/route?source=' + source);
      const data = await res.json();

      if (!data.stops || !data.stops.length) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-secondary">No route data. Generate one using "Optimize Route" button.</td></tr>';
        return;
      }

      tbody.innerHTML = '';

      // Clear existing markers and routes
      if (routeLayer) routeLayer.remove();
      markers.forEach(m => m.remove());
      markers = [];

      const latlngs = [];
      let totalDist = 0;
      let totalTime = 0;

      data.stops.forEach((s, idx) => {
        const tr = document.createElement('tr');

        totalDist += s.distance_from_prev_km || 0;
        totalTime += s.est_travel_time_min || 0;

        // Highlight depot stops
        const rowClass = (s.label && s.label.includes('Depot')) ? 'table-info' : '';

        tr.innerHTML = `
          <td class="${rowClass}"><strong>${idx + 1}</strong></td>
          <td class="${rowClass}">${s.label || '-'}</td>
          <td class="${rowClass}"><code>${s.bin_id || '-'}</code></td>
          <td class="${rowClass}"><small>${s.lat ? s.lat.toFixed(4) : '-'}, ${s.lon ? s.lon.toFixed(4) : '-'}</small></td>
          <td class="${rowClass}">${s.distance_from_prev_km != null ? s.distance_from_prev_km.toFixed(2) : '-'}</td>
          <td class="${rowClass}">${s.est_travel_time_min != null ? s.est_travel_time_min.toFixed(1) : '-'}</td>
        `;
        tbody.appendChild(tr);

        // Add markers
        if (s.lat && s.lon) {
          const ll = [s.lat, s.lon];
          latlngs.push(ll);
          
          const isDepot = s.label && s.label.includes('Depot');
          const iconColor = isDepot ? 'green' : 'blue';
          
          const marker = L.marker(ll, {
            icon: L.divIcon({
              className: 'custom-marker',
              html: `<div style="background: ${iconColor}; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${idx + 1}</div>`,
              iconSize: [30, 30]
            })
          }).addTo(map);
          
          marker.bindPopup(`<strong>${s.label}</strong><br>Bin: ${s.bin_id || 'N/A'}<br>Stop ${idx + 1}`);
          markers.push(marker);
        }
      });

      // Draw route line
      if (latlngs.length > 1) {
        routeLayer = L.polyline(latlngs, { 
          color: '#0d6efd', 
          weight: 3,
          opacity: 0.7 
        }).addTo(map);
        map.fitBounds(routeLayer.getBounds().pad(0.1));
      }

      // Update statistics
      document.getElementById('stat-stops').textContent = data.stops.length - 2; // Exclude depot
      document.getElementById('stat-distance').textContent = totalDist.toFixed(2) + ' km';
      document.getElementById('stat-time').textContent = (totalTime / 60).toFixed(1) + ' hours';

    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading route</td></tr>';
    }
  }

  function refreshRoute() {
    loadRoute('test');
  }

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', () => {
    initMap();
    loadPredictions('test', 'test-predictions-body');
    loadPredictions('prototype', 'proto-predictions-body');
    loadRoute('test');
  });

</script>
{% endblock %}
