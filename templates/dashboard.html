{% extends "base.html" %}

{% block title %}Smart Waste Collection Dashboard{% endblock %}

{% block content %}

<!-- =================== HEADER =================== -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="mb-0">Smart Waste Collection Dashboard</h1>
</div>

<p class="text-secondary mb-4">
  ML-powered waste collection optimisation
</p>

<!-- =================== TABS =================== -->
<ul class="nav nav-tabs" role="tablist">
  <li class="nav-item">
    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-test">
      1. Predictions (Test)
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-route">
      2. Optimal Route (Test)
    </button>
  </li>
  <li class="nav-item">
    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-prototype">
      3. Prototype Predictions
    </button>
  </li>
</ul>

<!-- =================== TAB CONTENT =================== -->
<div class="tab-content mt-3">

  <!-- ================= TAB 1 ================= -->
  <div class="tab-pane fade show active" id="tab-test">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Bins Predicted Full Soon (Test Dataset)</h4>

        <div class="table-responsive">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Bin ID</th>
                <th>Location</th>
                <th>Fill %</th>
                <th>Predicted Full At</th>
              </tr>
            </thead>
            <tbody id="test-predictions-body">
              <tr><td colspan="5" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= TAB 2 ================= -->
  <div class="tab-pane fade" id="tab-route">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Optimal Collection Route (Test)</h4>

        <div id="route-map-test" style="height: 450px; border-radius: 8px;"></div>

        <div class="table-responsive mt-3">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>Stop #</th>
                <th>Label</th>
                <th>Bin ID</th>
                <th>Distance (km)</th>
                <th>Travel Time (min)</th>
              </tr>
            </thead>
            <tbody id="route-stops-body-test">
              <tr><td colspan="5" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ================= TAB 3 ================= -->
  <div class="tab-pane fade" id="tab-prototype">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Prototype Predictions (Live)</h4>
        <p class="text-secondary">Real-time data from Raspberry Pi</p>

        <div class="table-responsive">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Bin ID</th>
                <th>Location</th>
                <th>Fill %</th>
                <th>Predicted Full At</th>
                <th>Recorded At</th> <!-- âœ… NEW -->
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="proto-predictions-body">
              <tr><td colspan="7" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
async function loadPredictions(source, tbodyId) {
  const tbody = document.getElementById(tbodyId);
  tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

  try {
    const res = await fetch('/api/predictions?source=' + source);
    const data = await res.json();

    if (!data.length) {
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-secondary">No data</td></tr>';
      return;
    }

    tbody.innerHTML = '';

    data.forEach((row, idx) => {
      const tr = document.createElement('tr');

      const fillClass =
        row.predicted_fill_percent >= 80 ? 'text-danger' :
        row.predicted_fill_percent >= 60 ? 'text-warning' :
        'text-success';

      const statusBadge =
        row.predicted_fill_percent >= 80 ? '<span class="badge bg-danger">URGENT</span>' :
        row.predicted_fill_percent >= 60 ? '<span class="badge bg-warning">MEDIUM</span>' :
        '<span class="badge bg-success">LOW</span>';

      const recordedAt = row.recorded_at
        ? new Date(row.recorded_at).toLocaleString()
        : '-';

      tr.innerHTML = `
        <td>${idx + 1}</td>
        <td><code>${row.bin_id || '-'}</code></td>
        <td><small>${row.location_name || '-'}</small></td>
        <td class="${fillClass}">
          <strong>${row.predicted_fill_percent.toFixed(1)}%</strong>
        </td>
        <td><small>${row.predicted_full_at || '-'}</small></td>
        <td><small>${recordedAt}</small></td>
        <td>${statusBadge}</td>
      `;

      tbody.appendChild(tr);
    });

  } catch (err) {
    console.error(err);
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
  }
}

// ---------- INIT ----------
document.addEventListener('DOMContentLoaded', () => {
  loadPredictions('test', 'test-predictions-body');
  loadPredictions('prototype', 'proto-predictions-body');

  setInterval(() => {
    loadPredictions('prototype', 'proto-predictions-body');
  }, 30000);
});
</script>
{% endblock %}
