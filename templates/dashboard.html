{% extends "base.html" %}

{% block title %}Smart Waste Collection Dashboard{% endblock %}

{% block content %}

<!-- =================== HEADER =================== -->
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Smart Waste Collection Dashboard</h1>
    <div>
        <a href="/dev/upload_test_predictions" 
           class="btn btn-outline-info me-2"
           id="btn-upload-predictions">
            Upload Predictions
        </a>
        <a href="/dev/upload_route_test"
           class="btn btn-outline-warning"
           id="btn-upload-route"
           style="display:none;">
            Optimize Route
        </a>
    </div>
</div>

<p class="text-secondary mb-4">
    ML-powered waste collection optimization with KNN route planning
</p>

<!-- =================== TABS =================== -->
<ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-test-pred" data-bs-toggle="tab"
            data-bs-target="#panel-test-pred" type="button" role="tab">
      1. Predictions (Test)
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-route" data-bs-toggle="tab"
            data-bs-target="#panel-route" type="button" role="tab">
      2. Optimal Route (Test)
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-proto-pred" data-bs-toggle="tab"
            data-bs-target="#panel-proto-pred" type="button" role="tab">
      3. Prototype Predictions
    </button>
  </li>
</ul>

<!-- =================== TAB CONTENT =================== -->
<div class="tab-content mt-3">

  <!-- ------------ TAB 1: TEST PREDICTIONS ------------ -->
  <div class="tab-pane fade show active" id="panel-test-pred" role="tabpanel">
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Bins Predicted Full Soon (Test Dataset)</h4>
        <p class="text-secondary">ML predictions sorted by urgency</p>
        <div class="table-responsive">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Bin ID</th>
                <th>Location</th>
                <th>Fill %</th>
                <th>Predicted Full At</th>
              </tr>
            </thead>
            <tbody id="test-predictions-body">
              <tr><td colspan="5" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ------------ TAB 2: TEST ROUTE ------------ -->
  <div class="tab-pane fade" id="panel-route" role="tabpanel">
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="card-title mb-0">Optimal Collection Route (Test - KNN)</h4>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-2" onclick="toggleAllBins('test')">
              <span id="bins-toggle-text-test">Show All Bins</span>
            </button>
            <button class="btn btn-sm btn-outline-info" onclick="refreshRoute('test')">
              üîÑ Refresh
            </button>
          </div>
        </div>

        <!-- Route Statistics -->
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Total Stops</div>
              <div class="stat-value" id="stat-stops-test">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Total Distance</div>
              <div class="stat-value" id="stat-distance-test">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Est. Time</div>
              <div class="stat-value" id="stat-time-test">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Avg Speed</div>
              <div class="stat-value">30 km/h</div>
            </div>
          </div>
        </div>

        <div id="route-map-test" style="height: 500px; border-radius: 8px;"></div>

        <div class="mt-4 table-responsive">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>Stop #</th>
                <th>Label</th>
                <th>Bin ID</th>
                <th>Coordinates</th>
                <th>Distance (km)</th>
                <th>Travel Time (min)</th>
              </tr>
            </thead>
            <tbody id="route-stops-body-test">
              <tr><td colspan="6" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- ------------ TAB 3: PROTOTYPE PREDICTIONS ------------ -->
  <div class="tab-pane fade" id="panel-proto-pred" role="tabpanel">
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <h4 class="card-title mb-0">Prototype Bin Predictions (Live)</h4>
            <p class="text-secondary mb-0">Real-time data from Raspberry Pi sensors</p>
          </div>
          <button class="btn btn-success" onclick="showRouteModal()">
            üó∫Ô∏è Generate Prototype Route
          </button>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-3">
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Total Bins</div>
              <div class="stat-value" id="proto-total-bins">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Avg Fill Level</div>
              <div class="stat-value" id="proto-avg-fill">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Urgent (‚â•80%)</div>
              <div class="stat-value text-danger" id="proto-high-priority">-</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stat-card">
              <div class="stat-label">Last Update</div>
              <div class="stat-value" id="proto-last-update" style="font-size: 1rem;">-</div>
            </div>
          </div>
        </div>

        <!-- Predictions Table -->
        <div class="table-responsive">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>#</th>
                <th>Bin ID</th>
                <th>Location</th>
                <th>Fill %</th>
                <th>Recorded At</th>
                <th>Predicted Full At</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="proto-predictions-body">
              <tr><td colspan="7" class="text-center">Loading...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Auto-refresh toggle -->
        <div class="d-flex justify-content-between align-items-center mt-3">
          <small class="text-secondary">
            <span class="badge bg-info" id="refresh-indicator">‚óè</span> 
            Auto-refresh every 30 seconds
          </small>
          <button class="btn btn-sm btn-outline-secondary" onclick="loadPredictions('prototype', 'proto-predictions-body')">
            üîÑ Refresh Now
          </button>
        </div>
      </div>
    </div>

    <!-- Prototype Route Map -->
    <div class="card" id="proto-route-card" style="display: none;">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="card-title mb-0">Prototype Collection Route</h4>
          <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllBins('prototype')">
            <span id="bins-toggle-text-proto">Show All Bins</span>
          </button>
        </div>

        <!-- Route Statistics -->
        <div class="row mb-3">
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-label">Stops</div>
              <div class="stat-value" id="stat-stops-proto">-</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-label">Distance</div>
              <div class="stat-value" id="stat-distance-proto">-</div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="stat-card">
              <div class="stat-label">Est. Time</div>
              <div class="stat-value" id="stat-time-proto">-</div>
            </div>
          </div>
        </div>

        <div id="route-map-proto" style="height: 400px; border-radius: 8px;"></div>

        <div class="mt-3 table-responsive">
          <table class="table table-sm table-striped table-dark align-middle">
            <thead>
              <tr>
                <th>Stop</th>
                <th>Label</th>
                <th>Bin ID</th>
                <th>Distance (km)</th>
                <th>Travel Time (min)</th>
              </tr>
            </thead>
            <tbody id="route-stops-body-proto">
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Route Generation Modal -->
<div class="modal fade" id="routeModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title">Generate Prototype Route</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Depot Latitude</label>
          <input type="number" class="form-control" id="depot-lat" step="0.000001" value="55.6761">
        </div>
        <div class="mb-3">
          <label class="form-label">Depot Longitude</label>
          <input type="number" class="form-control" id="depot-lon" step="0.000001" value="12.5683">
        </div>
        <div class="mb-3">
          <label class="form-label">Fill Threshold (%)</label>
          <input type="number" class="form-control" id="threshold" min="0" max="100" value="70">
          <small class="text-secondary">Only include bins above this fill level</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="generateProtoRoute()">Generate Route</button>
      </div>
    </div>
  </div>
</div>

<style>
  .stat-card {
    background: #2a2a2a;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid #444;
  }
  .stat-label {
    font-size: 0.85rem;
    color: #aaa;
    margin-bottom: 5px;
  }
  .stat-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #0d6efd;
  }
  .form-control, .form-select {
    background: #2a2a2a;
    border-color: #444;
    color: #eee;
  }
  .form-control:focus {
    background: #333;
    border-color: #0d6efd;
    color: #eee;
  }
  #refresh-indicator {
    animation: pulse 2s infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }
</style>

{% endblock %}

{% block extra_scripts %}
<script>
  let maps = {};
  let routeLayers = {};
  let markers = {};
  let allBinsLayers = {};
  let showingAllBins = {};
  let autoRefreshInterval;

  /* ======================================================
     UTILITY FUNCTIONS
  ====================================================== */
  function formatDateTime(isoString) {
    if (!isoString) return '-';
    const date = new Date(isoString);
    return date.toLocaleString('en-GB', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: false
    });
  }

  function getStatusInfo(fillPercent) {
    if (fillPercent >= 80) {
      return {
        label: 'URGENT',
        class: 'bg-danger',
        description: 'Bin near full or full, prioritised for compaction or collection'
      };
    } else if (fillPercent >= 50) {
      return {
        label: 'MEDIUM',
        class: 'bg-warning',
        description: 'Bin approaching capacity, monitor closely'
      };
    } else {
      return {
        label: 'LOW',
        class: 'bg-success',
        description: 'Bin operating at low capacity, no action required'
      };
    }
  }

  /* ======================================================
     TAB MANAGEMENT
  ====================================================== */
  function updateUploadButtons(activeTab) {
    const btnPred = document.getElementById("btn-upload-predictions");
    const btnRoute = document.getElementById("btn-upload-route");
    
    if (activeTab === "panel-test-pred") {
      btnPred.style.display = "inline-block";
      btnRoute.style.display = "none";
    } else if (activeTab === "panel-route") {
      btnPred.style.display = "none";
      btnRoute.style.display = "inline-block";
    } else {
      btnPred.style.display = "none";
      btnRoute.style.display = "none";
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    const tabs = document.querySelectorAll('button[data-bs-toggle="tab"]');
    tabs.forEach(btn => {
      btn.addEventListener("shown.bs.tab", (event) => {
        const target = event.target.getAttribute("data-bs-target").substring(1);
        updateUploadButtons(target);
      });
    });
    updateUploadButtons("panel-test-pred");
  });

  /* ======================================================
     LOAD PREDICTIONS
  ====================================================== */
  async function loadPredictions(source, tbodyId) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

    try {
      const res = await fetch('/api/predictions?source=' + source);
      const data = await res.json();

      if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-secondary">No predictions found. Connect your Raspberry Pi to send data.</td></tr>';
        
        if (source === 'prototype') {
          document.getElementById('proto-total-bins').textContent = '0';
          document.getElementById('proto-avg-fill').textContent = '0%';
          document.getElementById('proto-high-priority').textContent = '0';
        }
        return;
      }

      tbody.innerHTML = '';
      let totalFill = 0;
      let highPriority = 0;

      data.forEach((row, idx) => {
        const tr = document.createElement('tr');
        const location = (row.lat && row.lon) ? `${row.lat.toFixed(4)}, ${row.lon.toFixed(4)}` : (row.location_name || '-');
        const fillClass = row.predicted_fill_percent >= 80 ? 'text-danger' : row.predicted_fill_percent >= 50 ? 'text-warning' : 'text-success';
        const statusInfo = getStatusInfo(row.predicted_fill_percent);

        totalFill += row.predicted_fill_percent || 0;
        if (row.predicted_fill_percent >= 80) highPriority++;

        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td><code>${row.bin_id || '-'}</code></td>
          <td><small>${location}</small></td>
          <td class="${fillClass}"><strong>${row.predicted_fill_percent != null ? row.predicted_fill_percent.toFixed(1) + '%' : '-'}</strong></td>
          <td><small>${formatDateTime(row.recorded_at)}</small></td>
          <td><small>${row.predicted_full_at ? formatDateTime(row.predicted_full_at) : '-'}</small></td>
          <td><span class="badge ${statusInfo.class}" title="${statusInfo.description}">${statusInfo.label}</span></td>
        `;
        tbody.appendChild(tr);
      });

      // Update stats for prototype
      if (source === 'prototype') {
        document.getElementById('proto-total-bins').textContent = data.length;
        document.getElementById('proto-avg-fill').textContent = (totalFill / data.length).toFixed(1) + '%';
        document.getElementById('proto-high-priority').textContent = highPriority;
        document.getElementById('proto-last-update').textContent = new Date().toLocaleTimeString();
      }

    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">Error loading data</td></tr>';
    }
  }

  /* ======================================================
     MAP FUNCTIONS
  ====================================================== */
  function initMap(mapId, source) {
    if (maps[source]) return;
    
    maps[source] = L.map(mapId).setView([55.6761, 12.5683], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap',
      maxZoom: 18
    }).addTo(maps[source]);
    
    allBinsLayers[source] = L.layerGroup().addTo(maps[source]);
    markers[source] = [];
  }

  async function showAllBins(source) {
    try {
      const res = await fetch('/api/predictions?source=' + source);
      const data = await res.json();
      
      allBinsLayers[source].clearLayers();
      
      data.forEach((bin) => {
        if (bin.lat && bin.lon) {
          const fillPct = bin.predicted_fill_percent || 0;
          const color = fillPct >= 80 ? '#dc3545' : fillPct >= 50 ? '#ffc107' : '#28a745';
          
          const marker = L.circleMarker([bin.lat, bin.lon], {
            radius: 6,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          }).addTo(allBinsLayers[source]);
          
          marker.bindPopup(`
            <div style="min-width: 150px; color: #333;">
              <h6 style="margin: 0 0 8px 0;">üóëÔ∏è ${bin.bin_id}</h6>
              <strong>Fill:</strong> <span style="color: ${color}">${fillPct.toFixed(1)}%</span><br>
              <strong>Location:</strong> ${bin.location_name || 'Unknown'}
            </div>
          `);
        }
      });
    } catch (err) {
      console.error('Error loading bins:', err);
    }
  }

  function toggleAllBins(source) {
    showingAllBins[source] = !showingAllBins[source];
    const toggleText = document.getElementById('bins-toggle-text-' + source);
    
    if (showingAllBins[source]) {
      showAllBins(source);
      toggleText.textContent = 'Hide All Bins';
    } else {
      allBinsLayers[source].clearLayers();
      toggleText.textContent = 'Show All Bins';
    }
  }

  async function loadRoute(source, mapId, tbodyId, statsPrefix) {
    const tbody = document.getElementById(tbodyId);
    tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

    try {
      const res = await fetch('/api/route?source=' + source);
      const data = await res.json();

      if (!data.stops || !data.stops.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-secondary">No route. Click "Generate ${source === 'test' ? 'Test' : 'Prototype'} Route"</td></tr>`;
        return;
      }

      tbody.innerHTML = '';
      if (routeLayers[source]) routeLayers[source].remove();
      markers[source].forEach(m => m.remove());
      markers[source] = [];

      const latlngs = [];
      let totalDist = 0, totalTime = 0;

      data.stops.forEach((s, idx) => {
        const tr = document.createElement('tr');
        totalDist += s.distance_from_prev_km || 0;
        totalTime += s.est_travel_time_min || 0;
        const rowClass = (s.label && s.label.includes('Depot')) ? 'table-info' : '';

        tr.innerHTML = `
          <td class="${rowClass}"><strong>${idx + 1}</strong></td>
          <td class="${rowClass}">${s.label || '-'}</td>
          <td class="${rowClass}"><code>${s.bin_id || '-'}</code></td>
          <td class="${rowClass}">${s.distance_from_prev_km != null ? s.distance_from_prev_km.toFixed(2) : '-'}</td>
          <td class="${rowClass}">${s.est_travel_time_min != null ? s.est_travel_time_min.toFixed(1) : '-'}</td>
        `;
        tbody.appendChild(tr);

        if (s.lat && s.lon) {
          const ll = [s.lat, s.lon];
          latlngs.push(ll);
          
          const isDepot = s.label && s.label.includes('Depot');
          const iconColor = isDepot ? '#28a745' : '#0d6efd';
          
          const marker = L.marker(ll, {
            icon: L.divIcon({
              className: 'custom-marker',
              html: `<div style="background: ${iconColor}; color: white; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 3px solid #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.4);">${idx + 1}</div>`,
              iconSize: [36, 36]
            })
          }).addTo(maps[source]);
          
          marker.bindPopup(`<strong>${s.label}</strong><br>Stop ${idx + 1}`);
          markers[source].push(marker);
        }
      });

      if (latlngs.length > 1) {
        routeLayers[source] = L.polyline(latlngs, { 
          color: '#0d6efd', 
          weight: 4,
          opacity: 0.8
        }).addTo(maps[source]);
        maps[source].fitBounds(routeLayers[source].getBounds().pad(0.1));
      }

      document.getElementById(`stat-stops-${statsPrefix}`).textContent = data.stops.length - 2;
      document.getElementById(`stat-distance-${statsPrefix}`).textContent = totalDist.toFixed(2) + ' km';
      document.getElementById(`stat-time-${statsPrefix}`).textContent = (totalTime / 60).toFixed(1) + ' hrs';

    } catch (err) {
      console.error(err);
      tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading route</td></tr>';
    }
  }

  function refreshRoute(source) {
    const mapId = source === 'test' ? 'route-map-test' : 'route-map-proto';
    const tbodyId = source === 'test' ? 'route-stops-body-test' : 'route-stops-body-proto';
    const statsPrefix = source === 'test' ? 'test' : 'proto';
    loadRoute(source, mapId, tbodyId, statsPrefix);
  }

  /* ======================================================
     PROTOTYPE ROUTE GENERATION
  ====================================================== */
  function showRouteModal() {
    const modal = new bootstrap.Modal(document.getElementById('routeModal'));
    modal.show();
  }

  async function generateProtoRoute() {
    const depotLat = parseFloat(document.getElementById('depot-lat').value);
    const depotLon = parseFloat(document.getElementById('depot-lon').value);
    const threshold = parseFloat(document.getElementById('threshold').value);

    try {
      const res = await fetch('/dev/generate_prototype_route', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({depot_lat: depotLat, depot_lon: depotLon, threshold: threshold})
      });

      const data = await res.json();
      
      if (data.success) {
        bootstrap.Modal.getInstance(document.getElementById('routeModal')).hide();
        document.getElementById('proto-route-card').style.display = 'block';
        
        if (!maps['prototype']) {
          initMap('route-map-proto', 'prototype');
        }
        
        loadRoute('prototype', 'route-map-proto', 'route-stops-body-proto', 'proto');
        alert(`‚úÖ Route generated! ${data.stats.total_stops} stops, ${data.stats.total_distance_km} km`);
      } else {
        alert('‚ùå Error: ' + data.error);
      }
    } catch (err) {
      alert('‚ùå Error generating route: ' + err);
    }
  }

  /* ======================================================
     AUTO-REFRESH FOR PROTOTYPE
  ====================================================== */
  function startAutoRefresh() {
    autoRefreshInterval = setInterval(() => {
      loadPredictions('prototype', 'proto-predictions-body');
    }, 30000); // 30 seconds
  }

  /* ======================================================
     INITIALIZATION
  ====================================================== */
  document.addEventListener('DOMContentLoaded', () => {
    initMap('route-map-test', 'test');
    loadPredictions('test', 'test-predictions-body');
    loadPredictions('prototype', 'proto-predictions-body');
    loadRoute('test', 'route-map-test', 'route-stops-body-test', 'test');
    startAutoRefresh();
  });
</script>
{% endblock %}
